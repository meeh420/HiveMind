{"definition_id":"9e3de92f-14e4-4dac-a639-b131a8e0252f","last_refresh_timestamp":1391826681254,"postexecution_handlers":[],"definition":{"id":"9e3de92f-14e4-4dac-a639-b131a8e0252f","code":"crud.logger().info(\"in crudzilla_requested_resource:\"+crudzilla_requested_resource);\n\narguments.put(\"path_prefix\",\"\");//this is a bit of a hack\narguments.put(\"page_path_prefix\",\"\");\n\n\nString[] pathParts = crudzilla_requested_resource.startsWith(\"/\")?\n      crudzilla_requested_resource.substring(1).split(\"/\"):\n      crudzilla_requested_resource.split(\"/\");\n\nif(crudzilla_requested_resource.startsWith(\"/tags/\")){//enumerate by tags\n  \n  if(crudzilla_requested_resource.indexOf(\"/page/\") != -1){\n  \targuments.put(\"page\",pathParts[3]);\n    arguments.put(\"path_prefix\",\"../../../../\");   \n    arguments.put(\"page_path_prefix\",\"../../\");  \n    return crud.call(\"/\",arguments);\n  }\n  else\n  {\n    arguments.put(\"tags\",pathParts[1]);\n    arguments.put(\"path_prefix\",\"../../\");\n    return crud.call(\"/\",arguments);\n  }\n}\nelse\nif(crudzilla_requested_resource.startsWith(\"/search\")){//search query\n  \n  if(arguments.get(\"search_query\") == null)\n  \targuments.put(\"search_query\",httpRequest.getSession().getAttribute(\"lastQuery\"));\n  else\n    httpRequest.getSession().setAttribute(\"lastQuery\",search_query);\n  \n  if(crudzilla_requested_resource.indexOf(\"/page/\") != -1){\n  \targuments.put(\"page\",pathParts[2]);\n    arguments.put(\"path_prefix\",\"../../../\");   \n    arguments.put(\"page_path_prefix\",\"../../\");  \n    return crud.call(\"/\",arguments);\n  }\n  else\n  {\n    arguments.put(\"path_prefix\",\"../\");\n    return crud.call(\"/\",arguments);\n  }  \n  \n  //return crud.add(\"search_query\",pathParts[1]).add(\"path_prefix\",\"../../\").call(\"/\");\n}\nelse\nif(crudzilla_requested_resource.startsWith(\"/page/\")){//page\n  \n  arguments.put(\"page\",pathParts[1]);\n  arguments.put(\"path_prefix\",\"../../\");\n  arguments.put(\"page_path_prefix\",\"../../\");\n  return crud.call(\"/\",arguments);\n}\nelse\nif(crudzilla_requested_resource.startsWith(\"/parts/\")){\n  \n    Object part = crud.add(\"devId\",pathParts[1])\n    .add(\"partName\",pathParts[2])\n  \t.call(\"/secure/data/data-models/part/logic/get-by-name.stm\");\n      \n  \n    Object dev = crud.add(\"user_id\",pathParts[1])\n  \t\t\t\t\t.call(\"/user-management/user/profile/get.stm\");\n  \n  \tString resourcePath = \"crudzilla-parts/\"+dev.part_dir+\"/\"+part.id;\n  \n  \n    if(pathParts.length>3 && pathParts[3].matches(\"^[0-9]+(\\\\.[0-9]+)*\\$\")){\n      \n      Object partVersion = crud.add(\"devId\",pathParts[1])\n      .add(\"partId\",part.id)\n      .add(\"versionNumber\",pathParts[3])\n      .call(\"/secure/data/data-models/part_version/logic/get-by-version-number.stm\");\n      \n      resourcePath += \"/\"+partVersion.versionId+\"/\"+partVersion.fileName.substring(0,partVersion.fileName.lastIndexOf(\".zip\"));\n    }\n    else\n    {\n      Object partVersions = crud.add(\"devId\",pathParts[1])\n      .add(\"partId\",part.id)\n      .call(\"/secure/data/data-models/part_version/logic/list.stm\");\n      \n      if(partVersions.size()>0)      \n      \tresourcePath += \"/\"+partVersions[0].versionId+\"/\"+partVersions[0].fileName.substring(0,partVersions[0].fileName.lastIndexOf(\".zip\"));\n    }\n    \n    //crud.logger().info(\"serving \"+resourcePath);\n    return crud.call(resourcePath,arguments);\n}\nelse\nif(crudzilla_requested_resource.startsWith(\"/remote-install/\")){\n  return crud.add(\"access_token\",access_token)\n  .add(\"partPath\",crudzilla_requested_resource.substring(\"/remote-install\".length()))\n  .call(\"/remote-install\");\n}\nelse//process as usual\n{\n\treturn crud.call(crudzilla_requested_resource\n                     ,arguments\n                     ,crudzilla_requested_serverside);\n}","name":"interceptor","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"yes","requireAllIdentities":"no","lastModifiedTimeStamp":"1391818607123"},"preexecution_handlers":[],"execution_parameters":[],"reference_id":"b86c3297-6b28-45bd-ae5d-6dfb4a342712","accesscontrols":[]}