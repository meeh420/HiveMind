{"definition_id":"fda6c6b6-1022-4e45-92d3-cc419abe825c","last_refresh_timestamp":1392941125299,"postexecution_handlers":[],"definition":{"id":"fda6c6b6-1022-4e45-92d3-cc419abe825c","code":"import java.util.List;\n\ndef attachTransaction(c){\n  Object transaction  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_object\");\n  \n  if(transaction != null){\n    c.getArguments().put(\"crudzilla_transaction_object\",transaction);\n    c.getArguments().put(\"crudzilla_transaction_\"+transaction.get(\"name\"),httpRequest.getSession().getAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\")));\n    c.getArguments().put(\"crudzilla_transaction_action\",\"join\");\n  }\n  return c;\n}\n\n\ncrud.logger().info(\"searching taxonomyPath:\"+taxonomyPath+\"(\"+type+\")\");\n\nString[] pathParts = taxonomyPath.charAt(0)=='/'?taxonomyPath.substring(1).split('/'):taxonomyPath.split('/');\n\nList childTaxonomies = attachTransaction(crud.add(\"parent_id\",parent_id)\n\t\t\t\t\t\t.add(\"name\",pathParts[0]))\n\t\t\t\t\t\t.call(findChildTaxonomy);\n\nif(childTaxonomies.size()>0){\n  Object foundTaxonomyCategory = childTaxonomies.get(0);\n  \n  //find the right type of item\n  if(childTaxonomies.size()>1 && type != null && !type.isEmpty()){\n    for(Object tx:childTaxonomies){\n      if(type.compareTo(tx.type) == 0){\n          foundTaxonomyCategory = tx;\n          break;\n      }\n    }\n  }\n  \n  \n  \n  if(pathParts.length == 1){\n    return foundTaxonomyCategory;  \n  }\n  else\n  if(pathParts.length>1)\n  {\n    String newRelPath = pathParts[1];   \n    \n    \n    //decend into the first category that matches name\n    if(childTaxonomies.size()>1){\n      for(Object tx:childTaxonomies){\n        if(tx.type.compareTo(\"apptaxonomy-category\") == 0){\n            foundTaxonomyCategory = tx;\n            break;\n        }\n      }\n    }\n    \n    //move down path one level\n    for(int i=2;i<pathParts.length;i++)\n       newRelPath += \"/\"+pathParts[i];  \n    \n    //iterate through each node independently until a match is found\n    //for(Object taxonomy: childTaxonomies){//this should really only have one item\n      \n      Object crudWrapper = crud.add(\"taxonomyPath\",newRelPath)\n      .add(\"parent_id\",foundTaxonomyCategory.get(\"id\"));\n      \n      if(foundTaxonomyCategory.get(\"appTaxonomyId\").compareTo(\"0\") == 0)\n      \t crudWrapper.add(\"apptaxonomy_id\",foundTaxonomyCategory.get(\"id\"));\n      else\n         crudWrapper.add(\"apptaxonomy_id\",foundTaxonomyCategory.get(\"appTaxonomyId\"));\n      \n      //recursive call to this script\n      Object taxonomyNode = crudWrapper.add(\"type\",type).add(\"createPath\",createPath).call(findCategory);\n      if(taxonomyNode != null)return taxonomyNode;\n    //}\n  }\n}\nelse\nif(pathParts.length>0 && createPath.compareTo(\"true\") == 0)\n{\n  \n  \n  \n  String parentId = parent_id;\n  //create the rest of the taxonomy path\n  for(int i=0;i<pathParts.length;i++){\n        \n    \n    \n    parentId = attachTransaction(crud.add(\"presibling_id\",\"0\")\n    \t.add(\"link_id\",\"-1\")\n    \t.add(\"link_apptaxonomy_id\",\"-1\")\n    \t.add(\"type\",\"apptaxonomy-category\")\n    \t.add(\"name\",pathParts[i])\n        .add(\"apptaxonomy_id\",apptaxonomy_id)\n    \t.add(\"parent_id\",parentId))\n    \t.call(addAppTaxonomy);\n  }\n  \n  //return last added node\n  return attachTransaction(crud.add(\"id\",parentId)).call(getAppTaxonomy).get(0);\n}\nreturn null;","name":"find-category","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"yes","requireAllIdentities":null,"lastModifiedTimeStamp":"1392941124028"},"preexecution_handlers":[],"execution_parameters":[{"id":"c5e5f610-84b0-46ee-acf4-ec744a280937","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"findCategory","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/find-category.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"8551ef0b-9e83-4f63-b145-ebbbcbbd1244","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"findChildTaxonomy","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/find-category-children.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"5460d461-00f1-4013-a760-0c600d74053a","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"apptaxonomy_id","type":"string","validationRegEx":null,"defaultValue":"0","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"no","position":"0"},{"id":"4eb7ee41-22f7-4a4f-8e34-396f512dd0f9","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"getAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"../api/app-taxonomy/get-apptaxonomy.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"34fe34c0-a8d2-43d5-b678-eefe542b5ab6","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"parent_id","type":"string","validationRegEx":null,"defaultValue":"0","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"no","position":"0"},{"id":"265737d8-7063-432e-8043-21b1fba0eb14","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"createPath","type":"string","validationRegEx":null,"defaultValue":"false","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"no","position":"0"},{"id":"2037bb15-c7cd-4f9c-bb99-0b04b8043916","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"addAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"../api/app-taxonomy/add-apptaxonomy.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"8e823d77-f036-487f-a5b4-8c18c690bffb","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"type","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"no","position":"7"},{"id":"a685dedb-57a5-4a86-aa43-f2ba9034acf7","definitionId":"fda6c6b6-1022-4e45-92d3-cc419abe825c","required":"no","name":"relPath","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"no","position":"8"}],"reference_id":"1ce854e2-25a7-4f22-8daa-ad93a34b0c90","accesscontrols":[]}