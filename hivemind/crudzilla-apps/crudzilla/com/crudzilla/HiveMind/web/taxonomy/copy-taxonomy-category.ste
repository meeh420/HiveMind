{"definition_id":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","last_refresh_timestamp":1392941075509,"postexecution_handlers":[],"definition":{"id":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","code":"import java.util.List;\nimport java.util.ArrayList;\n\n\ndef attachTransaction(c){\n  Object transaction  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_object\");\n  \n  if(transaction != null){\n    //Object action  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_action\");\n    c.getArguments().put(\"crudzilla_transaction_object\",transaction);\n    c.getArguments().put(\"crudzilla_transaction_\"+transaction.get(\"name\"),httpRequest.getSession().getAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\")));\n    c.getArguments().put(\"crudzilla_transaction_action\",\"join\");\n  }\n  return c;\n}\n\ndef logTS(label){\n  arguments.put(\"curTS\",new java.util.Date().getTime());\n  //crud.logger().info(\"@\"+label+\" TS Diff \"+(arguments.get(\"curTS\") - arguments.get(\"prevTS\")));\n  arguments.put(\"prevTS\",arguments.get(\"curTS\")); \n}\n\ndef cloneTaxonomy(taxonomyItem,toCategoryTaxonomy){\n    \n  \n    //clone the crud definition\n    String newCrudId = attachTransaction(crud\n    .add(\"definition_id\",taxonomyItem.get(\"linkId\"))\n    .add(\"name\",taxonomyItem.get(\"name\")))\n    .call(cloneCrudDefinition);\n    \n    \n    //add cloned crud to Taxonomy\n    attachTransaction(crud\n    .add(\"apptaxonomy_id\",toCategoryTaxonomy.get(\"appTaxonomyId\"))\n    .add(\"parent_id\",toCategoryTaxonomy.get(\"id\"))\n    .add(\"presibling_id\",taxonomyItem.get(\"preSiblingId\"))\n    .add(\"link_id\",newCrudId)\n    .add(\"link_apptaxonomy_id\",taxonomyItem.get(\"linkAppTaxonomyId\"))\n    .add(\"type\",taxonomyItem.get(\"type\"))\n    .add(\"name\",taxonomyItem.get(\"name\")))\n    .call(addAppTaxonomy);\n    \n}\n\ndef runCrud(){\n  \n  String oldFromCategory = fromCategory;\n  String oldToCategory   = toCategory;\n  \n  \n  Object fromCategoryTaxonomy = crud.add(\"createPath\",\"false\")\n  \t\t\t\t\t\t\t\t\t.add(\"taxonomyPath\",oldFromCategory)\n  \t\t\t\t\t\t\t\t\t.add(\"parent_id\",parent_id)\n  \t\t\t\t\t\t\t\t\t.call(findAppTaxonomy);\n  \n  Object toCategoryTaxonomy = crud.add(\"createPath\",\"true\")\n  \t\t\t\t\t\t\t\t  .add(\"taxonomyPath\",oldToCategory)\n   \t\t\t\t\t\t\t\t  //.add(\"parent_id\",parent_id)\n  \t\t\t\t\t\t\t\t  .call(findAppTaxonomy);\n  Object destTaxo = toCategoryTaxonomy;\n  List listTaxonomies; \n  \n  Object firstDestNode = null;//destTaxo;\n  \n  arguments.put(\"curTS\",new java.util.Date().getTime());\n  arguments.put(\"prevTS\",arguments.get(\"curTS\"));\n  \n  if(includeRoot.compareTo(\"false\") == 0 && fromCategoryTaxonomy.type.compareTo(\"apptaxonomy-category\") == 0){\n      listTaxonomies = attachTransaction(crud.add(\"parent_id\",fromCategoryTaxonomy.get(\"id\")))\n    .call(getAppTaxonomies);\n  }\n  else{\n      listTaxonomies = new ArrayList();\n      listTaxonomies.add(fromCategoryTaxonomy);\n      //destTaxo.set(\"fromNode\",fromCategoryTaxonomy);\n  }\n  \n  crud.logger().info(\"COPY from \"+oldFromCategory+\" to \"+oldToCategory+\"(\"+includeRoot+\")\");\n  \n  for(Object taxonomyItem:listTaxonomies){\n    if(taxonomyItem.type.compareTo(\"apptaxonomy-category\") != 0){\n      cloneTaxonomy(taxonomyItem,toCategoryTaxonomy);    \n    }\n    else\n    {\n      String newFromRelPath = includeRoot.compareTo(\"false\") == 0?/*oldFromCategory+\"/\"+*/taxonomyItem.get(\"name\"):oldFromCategory;\n      String newToRelPath   = oldToCategory+\"/\"+taxonomyItem.get(\"name\");\n      \n      String parentId = fromCategoryTaxonomy.id;\n      if(includeRoot.compareTo(\"true\") == 0){//include the node then its children\n        parentId = fromCategoryTaxonomy.parentId;\n        newFromRelPath = fromCategoryTaxonomy.name;\n      }\n      \n      Object newDestTaxo = crud.add(\"fromCategory\",newFromRelPath)\n      \t\t\t\t.add(\"toCategory\",newToRelPath)\n      \t\t\t\t.add(\"parent_id\",parentId)\n      \t\t\t\t.call(copyAppTaxonomies);\n      \n      if(includeRoot.compareTo(\"true\") == 0)\n        firstDestNode = newDestTaxo;\n      \n      \n      logTS(\"Finished copying taxonomy \"+taxonomyItem.name);     \n    }\n  }\n  destTaxo.set(\"fromNode\",firstDestNode);\n  return destTaxo;\n}\n\nreturn runCrud();","name":"copy-taxonomy-category","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"no","requireAllIdentities":null,"lastModifiedTimeStamp":"1392941073998"},"preexecution_handlers":[],"execution_parameters":[{"id":"c628864e-7f97-4078-b419-26c0a188e1e8","definitionId":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","required":"no","name":"findAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/find-category.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"a9f3ced1-7c0d-4d3a-8c1a-ebf54045e70b","definitionId":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","required":"no","name":"getAppTaxonomies","type":"crud","validationRegEx":"","defaultValue":"../api/app-taxonomy/get-apptaxonomys.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"8130a45c-aed0-4124-a5d0-ae52ed2eb396","definitionId":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","required":"no","name":"cloneCrudDefinition","type":"crud","validationRegEx":"","defaultValue":"../api/primary-execution/crud-definition/clone-crud-definition.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"7e3574cf-a7dd-4868-a92b-80938dbc9db7","definitionId":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","required":"no","name":"addAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"../api/app-taxonomy/add-apptaxonomy.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"3f407cf7-fffa-40dc-b378-06c5127bec73","definitionId":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","required":"no","name":"copyAppTaxonomies","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/copy-taxonomy-category.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"9d05ab53-a05e-450b-bf2a-6385c03eed6c","definitionId":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","required":"no","name":"includeRoot","type":"string","validationRegEx":"","defaultValue":"false","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"5"},{"id":"186f4df5-8a21-4d67-ae1a-1f6554aa4f72","definitionId":"26dfed4c-69ed-47aa-8f20-4ad840c88a45","required":"no","name":"parent_id","type":"string","validationRegEx":"","defaultValue":"0","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"6"}],"reference_id":"c2a0c9b9-758f-4612-8aac-121f12f7e229","accesscontrols":[]}