{"definition_id":"27f234a4-1e44-4346-bd8f-4c009f12e13b","last_refresh_timestamp":1393271945502,"postexecution_handlers":[],"definition":{"id":"27f234a4-1e44-4346-bd8f-4c009f12e13b","code":"import java.util.Map;\nimport java.util.HashMap;\nimport com.crudzilla.platform.util.CrudzillaUtil;\nimport java.io.File;\nimport java.io.Writer;\nimport java.io.FileNotFoundException;\nimport java.io.BufferedWriter;\nimport java.io.FileWriter;\nimport org.apache.commons.io.FileUtils;\nimport net.sf.json.JSONObject;\n\n\ndef attachTransaction(c){\n  Object transaction  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_object\");\n  \n  if(transaction != null){\n    c.getArguments().put(\"crudzilla_transaction_object\",transaction);\n    c.getArguments().put(\"crudzilla_transaction_\"+transaction.get(\"name\"),httpRequest.getSession().getAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\")));\n    c.getArguments().put(\"crudzilla_transaction_action\",\"join\");\n  }\n  return c;\n}\n\ndef create(String generatorPath){\n  \n  crud.add(\"relPath\",relPath).call(\"../file-system/create.ste\");        \n  \n  Map refFile = (Map)attachTransaction(crud).call(generatorPath,arguments);      \n  \n  File file = CrudzillaUtil.getFile(crudzilla,relPath);\n  try\n  {\n    FileUtils.writeStringToFile(file, JSONObject.fromObject(refFile).toString());\n    \n    JSONObject ref = JSONObject.fromObject(FileUtils.readFileToString(file));\n    \n    //serialize file based scripts to disk\n    crud.add(\"relPath\",relPath).add(\"crudExecutable\",ref).call(\"../file-system/crud-to-code-file.ste\");\n\n    //**CoreDAO.addDefinitionReference(this,_arguments,ref.getString(\"definition_id\"),ref.getString(\"reference_id\"),ref.getString(\"last_refresh_timestamp\"), getResourcePath());\n  }catch(Exception ex){\n    crud.logger().error(\"Error creating new reference file for \"+relPath,ex);\n    Map returnVal = new HashMap();\n    returnVal.put(\"status\", \"error\");\n    return returnVal;\n  }\n  \n  Map returnVal = new HashMap();\n  returnVal.put(\"status\", \"success\");\n  return returnVal;\n}\n\ndef runCrud(){\n  File file = CrudzillaUtil.getFile(crudzilla,relPath);\n  \n  String ext = relPath.substring(relPath.lastIndexOf(\".\"));\n  String generatorPath = (String)((Map)crudzilla.sysSettings().get(\"crudzilla_crud_generator_paths\")).get(ext);\n  \n  return create(generatorPath);\n}\n\nreturn runCrud();","name":"bake","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"no","requireAllIdentities":"no","lastModifiedTimeStamp":"1393271941853"},"preexecution_handlers":[],"execution_parameters":[],"reference_id":"5b144b6c-36ab-43ab-85c0-81bf3eb40f8f","accesscontrols":[]}