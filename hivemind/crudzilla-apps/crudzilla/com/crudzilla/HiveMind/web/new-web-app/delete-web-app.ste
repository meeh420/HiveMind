{"definition_id":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","last_refresh_timestamp":1400871600073,"postexecution_handlers":[],"definition":{"id":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","code":"import com.crudzilla.platform.Crudzilla;\nimport org.apache.commons.dbutils.QueryRunner;\nimport java.io.File;\nimport net.sf.json.JSONObject;\nimport com.crudzilla.platform.instantiator.bean.InstantiatorReference;\nimport org.apache.commons.io.FileUtils;\nimport com.crudzilla.platform.util.CrudzillaUtil;\n\ndef attachTransaction(c){\n  Object transaction  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_object\");\n  \n  if(transaction != null){\n    c.getArguments().put(\"crudzilla_transaction_object\",transaction);\n    c.getArguments().put(\"crudzilla_transaction_\"+transaction.get(\"name\"),httpRequest.getSession().getAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\")));\n    c.getArguments().put(\"crudzilla_transaction_action\",\"join\");\n  }\n  return c;\n}\n\ndef startTransactionOnly(){\n  Object transaction  = crud.call(\"/crudzilla-app-settings/transaction.ins\");  \n  \n  httpRequest.getSession().setAttribute(\"crudzilla_transaction_object\",transaction);  \n  httpRequest.getSession().setAttribute(\"crudzilla_transaction_action\",\"start_only\");\n  \n  arguments.put(\"crudzilla_transaction_object\",transaction);\n  arguments.put(\"crudzilla_transaction_action\",\"start_only\");\n  crud.call(\"/crudzilla-app-settings/transactor.stm\",arguments);  \n  \n  httpRequest.getSession().setAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\"),arguments.get(\"crudzilla_transaction_\"+transaction.get(\"name\")));\n}\n\n\ndef commitTransactionOnly(){\n  Object transaction  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_object\");\n  \n  if(transaction != null){\n    \n    attachTransaction(crud);\n    arguments.put(\"crudzilla_transaction_action\",\"commit_only\");\n    crud.call(\"/crudzilla-app-settings/transactor.stm\",arguments);\n    \n    httpRequest.getSession().removeAttribute(\"crudzilla_transaction_object\");  \n    httpRequest.getSession().removeAttribute(\"crudzilla_transaction_action\");      \n    httpRequest.getSession().removeAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\"));\n    \n    arguments.remove(\"crudzilla_transaction_object\");\n    arguments.remove(\"crudzilla_transaction_\"+transaction.get(\"name\"));\n    arguments.remove(\"crudzilla_transaction_action\");    \n  }\n}\n\n\ndef runCrud(){\n  //startTransactionOnly();\n \n  \n  \n  \n  Object path2IdMapping = crud.call(\"../taxonomy/path2id-cache.ins\");\n  \n  //delete app base dir\n  String jettyHome = \"\";\n  if(System.getProperty(\"jetty.home\") != null && !System.getProperty(\"jetty.home\").isEmpty())\n    jettyHome = System.getProperty(\"jetty.home\");\n  else\n    jettyHome = crudzilla.sysSettings().get(\"crudzilla_jetty_home\");\n  \n  \n  String appName = relPath.split('/')[relPath.split('/').length-1];\n  String assetBaseDir = (new File(crud.appBaseDir()+\"/\"+crudzilla.sysSettings().get(\"crudzilla_asset_base\")).getCanonicalPath());\n \n  //delete from crudbase\n  Object appTaxonomy = crud.add(\"createPath\",\"false\")\n  \t\t\t\t\t\t   .add(\"taxonomyPath\",relPath)\n  \t\t\t\t\t\t   .call(findAppTaxonomy);\n  \n  if(appTaxonomy != null)\n      crud.add(\"id\",appTaxonomy.id).call(deleteAppCategory);\n\n  //delete realm information\n  new File(jettyHome+\"/etc/\"+appName+\".jdbc.realm.properties\").delete();\n\n  //delete context file\n  new File(jettyHome+\"/contexts/\"+appName+\".xml\").delete();\n\n  //delete war file\n  new File(jettyHome+\"/webapps/\"+appName+\".war\").delete();\n\n  //******************delete from applist*******************************\n\n  //delete app entry crud\n  Object appEntryTaxonomy = crud.add(\"createPath\",\"false\")\n  \t\t\t\t\t\t\t\t//.add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\"))\n  \t\t\t\t\t\t\t\t.add(\"taxonomyPath\",\"com/crudzilla/HiveMind/web/new-web-app/app-list/\"+appName)\n  \t\t\t\t\t\t\t\t.call(findAppTaxonomy);\n  if(appEntryTaxonomy != null){\n    attachTransaction(crud.add(\"definition_id\",appEntryTaxonomy.linkId)).call(deleteCrudDefinition);//delete crud definition\n    attachTransaction(crud.add(\"id\",appEntryTaxonomy.id)).call(deleteAppTaxonomy);//remove from taxonomy\n  }\n\n  //delete entry from app list\n  Object appListEntries = crud.add(\"createPath\",\"false\")\n  \t\t\t\t\t\t\t\t//.add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\"))\n  \t\t\t\t\t\t\t\t.add(\"taxonomyPath\",\"com/crudzilla/HiveMind/web/new-web-app/app-list/apps\")\n  \t\t\t\t\t\t\t\t.call(findAppTaxonomy);\n  \n  \n  attachTransaction(crud.add(\"definitionId\",appListEntries.linkId)).add(\"defaultValue\",appName+\".ins\").call(deleteExecutionParameterByValue);\n\n  try{\n  //delete app entry crud executable\n  new File(assetBaseDir+\"/com/crudzilla/HiveMind/web/new-web-app/app-list/\"+appName+\".ins\").delete();  \n  }catch(Exception e){\n    crud.logger().error(e);  \n  }\n  \n  //bake the app list to reflect update\n  crud.add(\"relPath\",\"com/crudzilla/HiveMind/web/new-web-app/app-list/apps\")\n  //.add(\"relPathFrom\",\"app-list/apps\")\n  .add(\"parent_id\",/*path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\")*/\"0\")\n  .call(bakeCrud);\n  //********************************************************************\n\n  try{\n    \n    crud.logger().info(\"DROP DATABASE:\"+dropDatabase+\" \"+dataSource);\n  //delete embeded database\n  if(dropDatabase.compareTo(\"true\") == 0){\n    \n    String dataSourcePath = (dataSource != null && !dataSource.isEmpty())?dataSource: relPath+\"/web/crudzilla-app-settings/application-datasource.ins\";\n    \n    \n    //extract data source name\n    String dataSourceName = dataSourcePath.substring(dataSourcePath.lastIndexOf(\"/\")+1);\n    \n    //temporarily copy the datasource to the new app directory\n    FileUtils.copyFileToDirectory(new File(assetBaseDir+\"/\"+dataSourcePath),new File(assetBaseDir+\"/com/crudzilla/HiveMind/web/crudzilla-temp\"));\n    \n    \n    Object appDataSource =  crud.call(\"/crudzilla-temp/\"+dataSourceName);\n    \n    //delete temp file\n    new File(assetBaseDir+\"/com/crudzilla/HiveMind/web/crudzilla-temp/\"+dataSourceName).delete();\n    \n    \n    //Object appDataSource = crud.call( dataSource != null && !dataSource.isEmpty()?dataSource: \"/crudzilla-app-settings/crudzilla-crud-datasource.ins\");  \n    \n    //this is an advanced use example for what is basically inter-app interaction\n    //we'll load the actual crud file since you can't run a crud across apps.\n    /**Object appDataSource =  crud.call(new InstantiatorReference(JSONObject.fromObject(org.apache.commons.io.FileUtils.readFileToString(new File(assetBaseDir+\"/\"+relPath+\"/web/\"+dataSourcePath))),crud));**/\n    \n    crud.logger().info(\"deleting app database \"+appDataSource.name+\" \"+appDataSource.url);\n    if(appDataSource.name != null && appDataSource.name.compareTo(\"crudzilla\") != 0){//safe guard against deleting product database\n      \n      if(appDataSource.driverClassName != null && appDataSource.driverClassName.compareTo(\"org.apache.derby.jdbc.EmbeddedDriver\") == 0){\n        appDataSource.set(\"url\",appDataSource.url.substring(0,appDataSource.url.lastIndexOf(':')+1)+appDataSource.name+\";shutdown=true\");\n        \n        crud.logger().info(\"shutting down db:\"+appDataSource.get(\"url\").toString());\n        try{\n        \tjava.sql.Connection conn = (java.sql.Connection)crud.add(\"dataSourceConfig\",appDataSource).call(\"/crudzilla-platform/engine/datasource-connection-creator.ste\");\n        }catch(Exception ex){\n          \n        }\n        //delete database\n        FileUtils.deleteDirectory(new File(jettyHome+\"/derby/\"+appDataSource.name));\n      }\n      else\n      {\n        //java.sql.Connection conn = (java.sql.Connection)crud.add(\"dataSourceConfig\",appDataSource).call(\"\"+Crudzilla.crudzilla().sysSettings().get(\"crudzilla_datasource_connection_creator\"));\n        //new QueryRunner().update(conn,\"drop database \"+appDataSource.name);\n        \n        crud.logger().info(\"dropping database:\"+appDataSource.name);\n        \n        crud.add(\"dbName\",appDataSource.name)\n            .add(\"crudzilla_datastatement_datasource_config\",appDataSource)\n        \t.call(\"/new-web-app/drop-database.stm\");\n      }\n    }\n  }\n  }catch(Exception e){\n    crud.logger().error(e);\n  }  \n  \n\n  crud.logger().info(\"deleting app \"+assetBaseDir+\"/\"+relPath);\n  //delete app assets\n  FileUtils.deleteDirectory(new File(assetBaseDir+\"/\"+relPath));\n\n  //flush app list from cache\n  crudzilla.inValidateCrudCache(CrudzillaUtil.getCrudFile(crudzilla,\"/new-web-app/app-list/apps.ins\").getCanonicalPath());  \n  \n  //commitTransactionOnly();\n}\nrunCrud();\nreturn \"done\";","name":"delete-web-app","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"no","requireAllIdentities":null,"lastModifiedTimeStamp":"1400871599192"},"preexecution_handlers":[],"execution_parameters":[{"id":"d501cf2d-8877-4346-96cc-6c37cd9471cf","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"findAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/find-category.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"c79c3d46-1e67-45eb-852f-84150448d19b","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"deleteAppCategory","type":"crud","validationRegEx":"","defaultValue":"../taxonomy/delete-category.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"1"},{"id":"30a4cb85-cf18-4e53-abb7-bcfc899db690","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"deleteAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"../api/app-taxonomy/delete-apptaxonomy.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"2"},{"id":"9b0cf4ff-f090-419b-931c-06113ab2e1b6","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"deleteCrudDefinition","type":"crud","validationRegEx":"","defaultValue":"../api/primary-execution/crud-definition/delete-crud-definition.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"3"},{"id":"a8af69d7-e0c2-4f8c-b129-9d40f2be8132","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"deleteExecutionParameterByValue","type":"crud","validationRegEx":"","defaultValue":"../api/nvp-processing/delete-execution-parameter-by-value.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"4"},{"id":"c27717f1-b82c-4f8a-b833-e9f477ad0ab0","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"dropDatabase","type":"string","validationRegEx":"","defaultValue":"false","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"5"},{"id":"6151af86-4b80-45b0-b53b-6d86b4152e46","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"dataSource","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"6"},{"id":"f52600ab-64a1-46b4-81b3-0898726c0f86","definitionId":"a32dddfb-ac0b-44b8-b867-41c3f00dd53a","required":"no","name":"bakeCrud","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/bake-crud.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"7"}],"reference_id":"61d65c6a-80ee-4012-a083-228c6f525b27","accesscontrols":[]}