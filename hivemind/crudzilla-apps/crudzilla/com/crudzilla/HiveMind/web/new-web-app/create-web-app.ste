{"definition_id":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","last_refresh_timestamp":1400871600154,"postexecution_handlers":[],"definition":{"id":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","code":"import org.apache.commons.io.FileUtils;\nimport java.io.File;\n\nimport java.sql.ResultSet;\nimport java.sql.ResultSetMetaData;\nimport java.sql.SQLException;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport org.apache.commons.dbutils.QueryRunner;\nimport org.apache.commons.dbutils.ResultSetHandler;\nimport com.crudzilla.platform.Crudzilla;\nimport com.crudzilla.platform.util.CrudzillaUtil;\n\ndef deWindowize(String path){\n   String normalizePath = path.replace(\"\\\\\",\"/\");   \n  \n   //remove windows drive letter part of the path\n   if(normalizePath.indexOf(':') != -1)\n      normalizePath = normalizePath.substring(normalizePath.indexOf(':')+1);  \n  \n   return normalizePath;\n}\n\n\n\ndef logTS(label){\n  arguments.put(\"curTS\",new java.util.Date().getTime());\n  crud.logger().info(\"@\"+label+\" TS Diff \"+(arguments.get(\"curTS\") - arguments.get(\"prevTS\")));\n  arguments.put(\"prevTS\",arguments.get(\"curTS\")); \n}\n\ndef attachTransaction(c){\n  Object transaction  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_object\");\n  \n  if(transaction != null){\n    //Object action  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_action\");\n    c.getArguments().put(\"crudzilla_transaction_object\",transaction);\n    c.getArguments().put(\"crudzilla_transaction_\"+transaction.get(\"name\"),httpRequest.getSession().getAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\")));\n    c.getArguments().put(\"crudzilla_transaction_action\",\"join\");\n  }\n  return c;\n}\n\ndef startTransactionOnly(){\n  Object transaction  = crud.call(\"/crudzilla-app-settings/transaction.ins\");  \n  \n  httpRequest.getSession().setAttribute(\"crudzilla_transaction_object\",transaction);  \n  httpRequest.getSession().setAttribute(\"crudzilla_transaction_action\",\"start_only\");\n  \n  arguments.put(\"crudzilla_transaction_object\",transaction);\n  arguments.put(\"crudzilla_transaction_action\",\"start_only\");\n  crud.call(\"/crudzilla-app-settings/transactor.stm\",arguments);  \n  \n  httpRequest.getSession().setAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\"),arguments.get(\"crudzilla_transaction_\"+transaction.get(\"name\")));\n}\n\n\ndef commitTransactionOnly(){\n  Object transaction  = httpRequest.getSession().getAttribute(\"crudzilla_transaction_object\");\n  \n  if(transaction != null){\n    \n    attachTransaction(crud);\n    arguments.put(\"crudzilla_transaction_action\",\"commit_only\");\n    crud.call(\"/crudzilla-app-settings/transactor.stm\",arguments);\n    \n    httpRequest.getSession().removeAttribute(\"crudzilla_transaction_object\");  \n    httpRequest.getSession().removeAttribute(\"crudzilla_transaction_action\");      \n    httpRequest.getSession().removeAttribute(\"crudzilla_transaction_\"+transaction.get(\"name\"));\n    \n    arguments.remove(\"crudzilla_transaction_object\");\n    arguments.remove(\"crudzilla_transaction_\"+transaction.get(\"name\"));\n    arguments.remove(\"crudzilla_transaction_action\");    \n  }\n}\n\n\n\ndef runCrud(){\n\n  //startTransactionOnly();\n  \n  \n  arguments.put(\"curTS\",new java.util.Date().getTime());\n  arguments.put(\"prevTS\",arguments.get(\"curTS\"));\n  //Object path2IdMapping = crud.call(\"../taxonomy/path2id-cache.ins\");\n  \n  //copy default system setting cruds\n  String newRelPath = relPath;//deWindowize(new File().getCanonicalPath());\n  if(newRelPath.charAt(0) == '/')\n      newRelPath = newRelPath.substring(1);  \n  \n  /*\n  if(true){\n  \tcrud.add(\"fromCategory\",\"dev-logging\")\n      .add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/dev-logging\"))\n      .add(\"toCategory\",newRelPath+\"/web/dev-logging\")\n      .call(copyAppTaxonomy);\n    \n    return false;\n  }\n  */\n  \n  String jettyHome = \"\";\n  if(System.getProperty(\"jetty.home\") != null && !System.getProperty(\"jetty.home\").isEmpty())\n    jettyHome = System.getProperty(\"jetty.home\");\n  else\n    jettyHome = crudzilla.sysSettings().get(\"crudzilla_jetty_home\");\n  \n  \n  String appName = relPath.split('/')[relPath.split('/').length-1];\n  String assetBaseDir = (new File(crud.appBaseDir()+\"/\"+crudzilla.sysSettings().get(\"crudzilla_asset_base\")).getCanonicalPath());\n  \n  \n  new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/classes\").mkdirs();\n  File libDir = new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/lib\");\n  libDir.mkdirs();\n  \n  boolean usingEmbededDB = false;\n  Object dataSourceConfig = null;\n  \n  if(dataSource != null && !dataSource.isEmpty()){\n        \n    if(!dataSource.endsWith(\".ins\")){//assume embeded database needs to be created\n      \n       dataSourceConfig = crud.call(\"/crudzilla-app-settings/crudzilla-crud-datasource.ins\");\n       dataSourceConfig.set(\"url\",\"jdbc:derby:\"+dataSource+\";create=true\");\n       usingEmbededDB = true;\n    }\n    else\n    {\n       //extract data source name\n       String dataSourceName = dataSource.substring(dataSource.lastIndexOf(\"/\")+1);\n      \n       //temporarily copy the datasource to the new app directory\n       FileUtils.copyFileToDirectory(new File(assetBaseDir+\"/\"+dataSource),new File(assetBaseDir+\"/com/crudzilla/HiveMind/web/crudzilla-temp\"));\n      \n       dataSourceConfig = crud.call(\"/crudzilla-temp/\"+dataSourceName,arguments);\n      \n       //delete temp file\n       new File(assetBaseDir+\"/com/crudzilla/HiveMind/web/crudzilla-temp/\"+dataSourceName).delete();\n    }\n    /*\n    if(createAuthTables.compareTo(\"yes\") == 0){\n        java.sql.Connection conn = (java.sql.Connection)crud.add(\"dataSourceConfig\",dataSourceConfig).call(\"\"+crudzilla.sysSettings().get(\"crudzilla_datasource_connection_creator\"));\n        \n      \n        String dataBaseUrl\t  = \"\";\n        String dataBaseUserName = \"\";\n        String dataBasePassWord = \"\";  \n        \n        //if(createDatabase.compareToIgnoreCase(\"yes\") == 0){\n        //  new QueryRunner().update(conn,\"create database \"+dataBaseName+\";\");\n        //  new QueryRunner().update(conn,\"use database \"+dataBaseName+\";\");\n        //}\n        //create users table\n        new QueryRunner().update(conn,createUsersTable);\n        \n        //create roles table\n        new QueryRunner().update(conn,createRolesTable);\n        \n        //create user_roles table\n        new QueryRunner().update(conn,createUserRolesTable);\n        \n        //create user_profile table\n        new QueryRunner().update(conn,createUserProfileTable);      \n      \n        //insert default user login info      \n        new QueryRunner().update(conn,\"insert into roles values(1,'developer')\"); \n        new QueryRunner().update(conn,\"insert into users values(1,'developer','developer')\");\n        new QueryRunner().update(conn,\"insert into user_roles values(1,1)\");\n        new QueryRunner().update(conn,\"insert into user_profile (user_id) values(1)\"); \n    }\n    */\n    \n    String userName = dataSourceConfig.user;\n    if(userName == null && dataSourceConfig.userName != null)\n    \tuserName = dataSourceConfig.userName;\n    else\n    if(userName == null)\n        userName = \"\";\n    \n    String passWord = dataSourceConfig.password;\n    if(passWord == null && dataSourceConfig.passWord != null)\n    \tpassWord = dataSourceConfig.passWord;\n    else\n    if(passWord == null)\n        passWord = \"\";    \n    \n    \n    //create app xml configs using datasource\n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/web.xml\"), webXml.replaceAll(\"#crudzilla-app-name\",appName).replaceAll(\"#crudzilla-app-home\",\"crudzilla\"+relPath+\"/web\"));\n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/jetty-web.xml\"), jettyWebXml.replaceAll(\"#crudzilla-app-name\",appName));\n    \n    \n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/jetty-env.xml\"), jettyEnvXml.replaceAll(\"#crudzilla-app-name\",appName).replaceAll(\"#crudzilla-database-driver\",dataSourceConfig.driverClassName).replaceAll(\"#crudzilla-database-url\",dataSourceConfig.url).replaceAll(\"#crudzilla-database-username\",userName).replaceAll(\"#crudzilla-database-password\",passWord));\n    \n    //write realm information\n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/\"+appName+\".jdbc.realm.properties\"), realmProperties.replaceAll(\"#crudzilla-database-driver\",dataSourceConfig.driverClassName).replaceAll(\"#crudzilla-database-url\",dataSourceConfig.url).replaceAll(\"#crudzilla-database-username\",userName).replaceAll(\"#crudzilla-database-password\",passWord));\n    FileUtils.copyFileToDirectory(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/\"+appName+\".jdbc.realm.properties\"),new File(jettyHome+\"/etc\"));\n    \n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/build.xml\"), buildXml.replaceAll(\"#crudzilla-app-name\",appName));\n  }\n  else{\n    //create app xml without datasource\n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/web.xml\"), webXml.replaceAll(\"#crudzilla-app-name\",appName).replaceAll(\"#crudzilla-app-home\",\"crudzilla\"+relPath+\"/web\").replaceAll(\"<!--BEGIN SECURITY SECTION-->\",\"<!--BEGIN SECURITY SECTION\").replaceAll(\"<!--END SECURITY SECTION-->\",\"END SECURITY SECTION-->\"));\n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/jetty-web.xml\"), jettyWebXml.replaceAll(\"#crudzilla-app-name\",appName).replaceAll(\"<!--BEGIN SECURITY HANDLER-->\",\"BEGIN SECURITY HANDLER\").replaceAll(\"<!--END SECURITY HANDLER-->\",\"END SECURITY HANDLER\").replaceAll(\"-->\",\"\").replaceAll(\"<!--\",\"\").replaceAll(\"BEGIN SECURITY HANDLER\",\"<!--BEGIN SECURITY HANDLER\").replaceAll(\"END SECURITY HANDLER\",\"END SECURITY HANDLER-->\"));\n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/jetty-env.xml\"), jettyEnvXml.replaceAll(\"#crudzilla-app-name\",appName));\n    \n    //write realm information\n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/\"+appName+\".jdbc.realm.properties\"), realmProperties.replaceAll(\"#crudzilla-app-name\",appName));\n    FileUtils.copyFileToDirectory(new File(assetBaseDir+\"/\"+relPath+\"/WEB-INF/\"+appName+\".jdbc.realm.properties\"),new File(jettyHome+\"/etc\"));\n    \n    FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/build.xml\"), buildXml.replaceAll(\"#crudzilla-app-name\",appName));\n  }\n  \n  logTS(\"Finished writing WEB-INF\");\n  //copy over jar dependencies\n  /*\n  String[] exts = new String[1];\n  exts[0] = new String(\"jar\");  \n  \n  for (File file : FileUtils.listFiles(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/core\"),exts,false)){\n    FileUtils.copyFileToDirectory(file,libDir);\n  }\n  \n  for (File file : FileUtils.listFiles(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/jvm-language-support\"),exts,false)){\n    FileUtils.copyFileToDirectory(file,libDir);\n  }\n  */\n  /***\n  //create index page\n  String html = FileUtils.readFileToString(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/index.html\"));\n  FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/web/index.html\"),html);\n  \n  //create login pages\n  html = FileUtils.readFileToString(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/login/login.html\"));\n  FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/web/login/login.html\"),html);\n  \n  html = FileUtils.readFileToString(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/login/login-error.html\"));\n  FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/web/login/login-error.html\"),html);\n  \n  //create secured index page\n  html = FileUtils.readFileToString(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/secure/index.html\"));\n  FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/web/secure/index.html\"),html);\n  \n  //copy static assets\n  FileUtils.copyDirectoryToDirectory(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/static-assets\"),new File(assetBaseDir+\"/\"+relPath+\"/web\"));\n  \n  //copy platform dependencies\n  //FileUtils.copyDirectoryToDirectory(new File(crud.appBaseDir()+\"/crudzilla-platform\"),new File(assetBaseDir+\"/\"+relPath+\"/web\"));\n  ***/\n\n  logTS(\"Finished FS operations\");\n  \n  /************************************************************************************\n  //copy platform dependencies\n  //*\"com/crudzilla/HiveMind/web/crudzilla-app-settings\"*\n  crud.add(\"fromCategory\",\"crudzilla-platform\")\n  .add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/crudzilla-platform\"))\n  .add(\"toCategory\",newRelPath+\"/web/crudzilla-platform\")\n  .call(copyAppTaxonomy);  \n  \n  logTS(\"Finished copying platform dependencies\");\n  \n  //copy default application settings\n  //*\"com/crudzilla/HiveMind/web/crudzilla-app-settings\"*\n  crud.add(\"fromCategory\",\"crudzilla-app-settings\")\n  .add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/crudzilla-app-settings\"))\n  .add(\"toCategory\",newRelPath+\"/web/crudzilla-app-settings\")\n  .call(copyAppTaxonomy);\n  \n  logTS(\"Finished copying settings\");\n  \n  //set default settings based on information currently available\n  Object settingsTaxonomy = crud.add(\"createPath\",\"false\").add(\"taxonomyPath\",newRelPath+\"/web/crudzilla-app-settings/system-settings\").call(findAppTaxonomy);\n  \n  Object settingsCrud     = crud.add(\"instantiator_id\",settingsTaxonomy.linkId).call(getInstantiator).get(0);\n  crud.add(\"definitionId\",settingsCrud.id).add(\"name\",\"crudzilla_velocity_template_root\").add(\"defaultValue\",assetBaseDir+\"/\"+newRelPath+\"/web\").call(updateExecutionParameterByName);\n  crud.add(\"definitionId\",settingsCrud.id).add(\"name\",\"crudzilla_crud_home\").add(\"defaultValue\",assetBaseDir+\"/\"+newRelPath+\"/web\").call(updateExecutionParameterByName);\n  crud.add(\"definitionId\",settingsCrud.id).add(\"name\",\"crudzilla_static_file_base_dir\").add(\"defaultValue\",assetBaseDir+\"/\"+newRelPath+\"/web\").call(updateExecutionParameterByName);\n  crud.add(\"definitionId\",settingsCrud.id).add(\"name\",\"crudzilla_engine_startup_handler\").add(\"defaultValue\",\"/start-up/on-crud-engine-startup.ste\").call(updateExecutionParameterByName);\n  \n  logTS(\"Finished initializing settings\");\n  *****************************************************************************/\n  /***\n  //copy default crud executables, they'll be overwritten later\n  FileUtils.copyDirectoryToDirectory(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/crudzilla-app-settings\"),new File(assetBaseDir+\"/\"+relPath+\"/web\"));\n  FileUtils.copyDirectoryToDirectory(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/crudzilla-platform\"),new File(assetBaseDir+\"/\"+relPath+\"/web\"));\n  //new File(assetBaseDir+\"/\"+relPath+\"/web/start-up\").mkdirs();\n  FileUtils.copyFileToDirectory(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/app-startup/on-crud-engine-startup.ste\"),new File(assetBaseDir+\"/\"+relPath+\"/web/app-startup\"));\n  logTS(\"Finished filesystem operations\");\n  **/\n  //copy application template\n  FileUtils.copyDirectoryToDirectory(new File(assetBaseDir+\"/com/crudzilla/HiveMind/crud-web-app-dependencies/web-app-template/web\"),new File(assetBaseDir+\"/\"+relPath));\n  \n  String html = FileUtils.readFileToString(new File(assetBaseDir+\"/\"+relPath+\"/web/index.html\"));\n  FileUtils.writeStringToFile(new File(assetBaseDir+\"/\"+relPath+\"/web/index.html\"),html.replaceAll(\"Project name\",appName));\n  \n  \n  //setup default datasource\n  /**if(usingEmbededDB){\n  \tObject dataSourceTaxonomy = crud.add(\"createPath\",\"false\").add(\"taxonomyPath\",newRelPath+\"/web/crudzilla-app-settings/crudzilla-crud-datasource\").call(findAppTaxonomy);\n  \tObject dataSourceCrud     = crud.add(\"instantiator_id\",dataSourceTaxonomy.linkId).call(getInstantiator).get(0);\n  \tcrud.add(\"definitionId\",dataSourceCrud.id).add(\"name\",\"name\").add(\"defaultValue\",dataSource).call(updateExecutionParameterByName);\n    crud.add(\"definitionId\",dataSourceCrud.id).add(\"name\",\"url\").add(\"defaultValue\",\"jdbc:derby:\"+dataSource+\";create=true\").call(updateExecutionParameterByName);\n  }\n  else\n  if(dataSourceConfig != null){\n      String dataSourceCrudPath = dataSource.substring(0,dataSource.lastIndexOf(\".ins\"));\n    \n  \t  crud.add(\"fromCategory\",dataSourceCrudPath)\n      .add(\"toCategory\",newRelPath+\"/web/crudzilla-app-settings\")\n      .call(copyAppTaxonomy); \n     \n      if(dataSourceCrudPath.lastIndexOf('/') != -1)\n          dataSourceCrudPath = dataSourceCrudPath.substring(dataSourceCrudPath.lastIndexOf('/')+1);\n      \n  \t  crud.add(\"definitionId\",settingsCrud.id).add(\"name\",\"crudzilla_default_datasource\").add(\"defaultValue\",dataSourceCrudPath+\".ins\").call(updateExecutionParameterByName);\n  }**/\n  \n  logTS(\"Finished setting datasource\");\n  /******************************************************************************\n  //*\"com/crudzilla/HiveMind/web/dev-logging\"*\n  //copy cwab logging support\n  crud.add(\"fromCategory\",\"dev-logging\")\n      .add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/dev-logging\"))\n      .add(\"toCategory\",newRelPath+\"/web/dev-logging\")\n      .call(copyAppTaxonomy);\n  \n  logTS(\"Finished copying dev logging\");\n  \n  //copy startup cruds\n  ///*\"com/crudzilla/HiveMind/web/start-up/on-crud-engine-startup\"*\n  crud.add(\"fromCategory\",\"start-up/on-crud-engine-startup\")\n      .add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/start-up\"))\n      .add(\"toCategory\",newRelPath+\"/web/start-up\")\n      .call(copyAppTaxonomy);\n  \n  \n  logTS(\"Finished copying engine setting\");\n  \n  ///*\"com/crudzilla/HiveMind/web/start-up/user-profile\"*\n  //copy user-profile setup\n  crud.add(\"fromCategory\", \"start-up/user-profile\")\n      .add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/start-up\"))\n      .add(\"toCategory\",newRelPath+\"/web/start-up/user-profile\")\n      .call(copyAppTaxonomy);  \n  \n  \n  logTS(\"Finished copying user profile\");\n  \n  //set default logging config\n  Object logConfigTaxonomy = crud.add(\"createPath\",\"false\").add(\"taxonomyPath\",newRelPath+\"/web/dev-logging/config\").call(findAppTaxonomy);\n  Object logConfigCrud     = crud.add(\"instantiator_id\",logConfigTaxonomy.linkId).call(getInstantiator).get(0);\n  crud.add(\"definitionId\",logConfigCrud.id).add(\"name\",\"classes\").add(\"defaultValue\",\"/dev-logging/classes/class-list.ins\").call(updateExecutionParameterByName);\n  crud.add(\"definitionId\",logConfigCrud.id).add(\"name\",\"name\").add(\"defaultValue\",appName+\"-logger\").call(updateExecutionParameterByName);\n  \n  logTS(\"Finished copying and initializing logging\");\n  \n  //bake app\n  crud.add(\"relPath\",deWindowize(new File(\"/\"+newRelPath+\"/web\").getCanonicalPath()))\n  //.add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/crudzilla-app-settings\"))\n  .call(bakeCrud);  \n  logTS(\"Finished baking app\");\n  *****************************************************************************/\n  \n  \n  /*\n  //bake systems settings\n  crud.add(\"relPath\",deWindowize(new File(\"/\"+newRelPath+\"/web/crudzilla-app-settings\").getCanonicalPath()))\n  //.add(\"parent_id\",path2IdMapping.get(\"com/crudzilla/HiveMind/web/crudzilla-app-settings\"))\n  .call(bakeCrud);\n  \n  logTS(\"Finished baking settings\");\n  \n  //bake engine startup cruds\n  crud.add(\"relPath\",deWindowize(new File(\"/\"+newRelPath+\"/web/start-up\").getCanonicalPath())).call(bakeCrud);\n  \n  logTS(\"Finished baking start up\");\n  \n  //bake logging cruds\n  crud.add(\"relPath\",deWindowize(new File(\"/\"+newRelPath+\"/web/dev-logging\").getCanonicalPath())).call(bakeCrud);\n  \n  logTS(\"Finished baking logging\");\n  */\n  \n  //create app config object for this app.\n  String hostPort = httpRequest.getServerPort() != 80?\":\"+httpRequest.getServerPort():\"\";\n  \n  Object appConfigTypeTemplate = \n    crud.add(\"createPath\",\"false\")\n        .add(\"taxonomyPath\",\"com/crudzilla/HiveMind/web/new-web-app/web-app-type-definition-template\")//\n        .add(\"parent_id\",/*path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\")*/\"0\")\n        .call(findAppTaxonomy);\n  \n  \n  String appConfigId = crud\n  .add(\"definition_id\",appConfigTypeTemplate.linkId)\n  .add(\"name\",appName)\n  .add(\"crudzilla_baseDir_value\",/*new File(relPath+\"/web\").getCanonicalPath()*/ relPath+\"/web\")\n  .add(\"crudzilla_contextPath_value\",\"http://\"+httpRequest.getServerName()+hostPort+\"/\"+appName+\"/crud-appserver\")\n  .add(\"crudzilla_name_value\",appName)\n  .add(\"crudzilla_main_value\",\"secure/index.html\")\n  .call(cloneCrudDefinition);\t\n  \n  logTS(\"Finished cloning app config\");\n  \n  //add it to the right category\n  Object appList = crud.add(\"createPath\",\"false\")\n  .add(\"taxonomyPath\",\"com/crudzilla/HiveMind/web/new-web-app/app-list\")\n  .add(\"parent_id\",/*path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\")*/\"0\")\n  .call(findAppTaxonomy);\n  \n  List definedApps = crud.add(\"parent_id\",appList.id).call(getAppTaxonomies);\n  \n  Object lastItem = null;\n  Map preSiblings = new HashMap();\n  for(Object obj:definedApps)\n     preSiblings.put(obj.preSiblingId,obj.preSiblingId);\n  \n  for(Object obj:definedApps){\n    //if this obj's id isn't a presibling, it is the last item\n    if(preSiblings.get(obj.id) == null){\n      lastItem = obj;\n      break;\n    }\n  }\n  \n  crud\n  .add(\"apptaxonomy_id\",appList.appTaxonomyId)\n  .add(\"parent_id\",appList.id)\n  .add(\"presibling_id\",lastItem != null?lastItem.id:\"-1\")\n  .add(\"link_id\",appConfigId)\n  .add(\"link_apptaxonomy_id\",\"-1\")\n  .add(\"type\",appConfigTypeTemplate.type)\n  .add(\"name\",appName)\n  .call(addAppTaxonomy);\n  \n  //add entry to app list\n  Object appListEntries = crud.add(\"createPath\",\"false\")//\n   \t\t\t\t\t\t\t  .add(\"parent_id\",/*path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\")*/\"0\")\n  \t\t\t\t\t\t\t  .add(\"taxonomyPath\",\"com/crudzilla/HiveMind/web/new-web-app/app-list/apps\")\n  \t\t\t\t\t\t\t .call(findAppTaxonomy);\n  crud\n  .add(\"definitionId\",appListEntries.linkId)\n  .add(\"defaultValue\",appName+\".ins\")\n  .add(\"name\",\"\")\n  .add(\"type\",\"crud\")\n  .add(\"evalRight\",\"yes\")\n  .add(\"isFinal\",\"yes\")\n  .add(\"position\",crud.call(\"/new-web-app/app-list/apps.ins\").size())\n  .call(addParameter);\n  \n  //bake new app config\n  crud.add(\"relPath\",\"/com/crudzilla/HiveMind/web/new-web-app/app-list/\"+appName)\n   //.add(\"relPathFrom\",\"com/crudzilla/HiveMind/web/new-web-app/app-list/\"+appName)\n   //.add(\"parent_id\",/*path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\")*/\"0\")\n  .call(bakeCrud);\n  \n  //bake the app list\n  crud.add(\"relPath\",\"/com/crudzilla/HiveMind/web/new-web-app/app-list/apps\")\n  //.add(\"relPathFrom\",\"app-list/apps\")\n  //.add(\"parent_id\",/*path2IdMapping.get(\"com/crudzilla/HiveMind/web/new-web-app\")*/\"0\")\n  .call(bakeCrud);\n  logTS(\"Finished baking app config\");\n  \n  //build this app and auto deploy\n  crud.add(\"relPath\",\"/\"+relPath+\"/build.xml\").call(\"build-web-app.ste\");\n  \n  \n  //deploy context file\n  crud.add(\"relPath\",relPath+\"/WEB-INF/jetty-web.xml\")\n      .add(\"appName\",appName)\n      .call(\"deploy-context.ste\");\n  \n  //flush app list from cache\n  crudzilla.inValidateCrudCache(CrudzillaUtil.getCrudFile(crudzilla,\"/new-web-app/app-list/apps.ins\").getCanonicalPath());  \n  \n  //commitTransactionOnly();\n}\n\nrunCrud();\n","name":"create-web-app","description":"","crudType":"scriptexecutor","type":"groovy-file","serverSideOnly":"no","requireAllIdentities":null,"lastModifiedTimeStamp":"1400871599413"},"preexecution_handlers":[],"execution_parameters":[{"id":"f62a27d2-c9cc-4399-92c7-9a0266cf877c","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"findAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/find-category.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"d263e470-ba27-4160-bfe7-0091970d0c9c","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"updateExecutionParameterByName","type":"crud","validationRegEx":"","defaultValue":"/api/nvp-processing/update-execution-parameter-value-by-name.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"cf8ec1ca-c9b9-4ca8-9ce3-5ea99d908972","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"buildXml","type":"xml","validationRegEx":"","defaultValue":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!-- You may freely edit this file. -->\n<project name=\"#crudzilla-app-name\" default=\"war\" basedir=\".\">\n    <description>Builds, tests, and runs the project #crudzilla-app-name.<\/description>    \n    \n    <target name=\"war\">\n      <war destfile=\"#crudzilla-app-name.war\" webxml=\"WEB-INF/web.xml\">\n        <!--Uncomment these lines to package a war that contains all cwab dependencies-->\n        <!--\n        <lib dir=\"${jetty.home}/lib/ext/crudzilla/core\"/>\n        <lib dir=\"${jetty.home}/lib/ext/crudzilla/jvm-language-support\"/>        \n        -->\n        \n        <lib dir=\"WEB-INF/lib\"/>\n        <webinf file=\"WEB-INF/jetty-web.xml\"/> \n        <webinf file=\"WEB-INF/jetty-env.xml\"/>      \n      <\/war>  \n      <copy file=\"#crudzilla-app-name.war\" todir=\"${jetty.home}/webapps\"/>\n    <\/target>\n<\/project>\n","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"c741ce1a-2415-45fb-91eb-0be2ad141d7c","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"bakeCrud","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/bake-crud.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"ae68793f-b6f9-4d01-a585-67afc51d7610","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"getInstantiator","type":"crud","validationRegEx":"","defaultValue":"/api/datastatements/get-instantiator.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"a964ad1d-0fa0-4781-a3fd-eb77ecc0fcbf","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"createUserRolesTable","type":"sql","validationRegEx":"","defaultValue":"create table user_roles\n(\n     user_id integer not null,\n     role_id integer not null\n)","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"a06c1d8c-3bb2-4946-acd4-05a3b152e8c9","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"copyAppTaxonomy","type":"crud","validationRegEx":"","defaultValue":"/taxonomy/copy-taxonomy-category.ste","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"9413efee-f664-49a4-80b5-826a83d82864","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"webXml","type":"xml","validationRegEx":"","defaultValue":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<web-app version=\"2.5\" xmlns=\"http://java.sun.com/xml/ns/javaee\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd\">\n    <servlet>\n        <servlet-name>CrudzillaAppServer<\/servlet-name>\n        <servlet-class>com.crudzilla.server.AppServer<\/servlet-class>\n        <init-param>\n            <param-name>app-home<\/param-name>\n            <param-value>#crudzilla-app-home<\/param-value>\n        <\/init-param>\n    <\/servlet>\n    <servlet-mapping>\n        <servlet-name>CrudzillaAppServer<\/servlet-name>\n        <url-pattern>/crud-appserver/*<\/url-pattern>\n    <\/servlet-mapping>\n    <session-config>\n        <session-timeout>\n            120\n        <\/session-timeout>\n    <\/session-config>\n    <welcome-file-list>\n        <welcome-file>index.html<\/welcome-file>\n    <\/welcome-file-list>\n  \n  \t<!--BEGIN SECURITY SECTION-->\n    <security-constraint>\n        <web-resource-collection>\n            <web-resource-name>#crudzilla-app-name Security<\/web-resource-name>            \n            <url-pattern>/crud-appserver/secure/*<\/url-pattern>\n        <\/web-resource-collection>\n        <auth-constraint>\n            <role-name>developer<\/role-name>\n        <\/auth-constraint>\n        <user-data-constraint>\n            <transport-guarantee>NONE<\/transport-guarantee>\n        <\/user-data-constraint>\n    <\/security-constraint>\n\n    <security-role>\n        <role-name>developer<\/role-name>\n    <\/security-role>\n\n    <login-config>\n        <auth-method>FORM<\/auth-method>\n        <realm-name>#crudzilla-app-name<\/realm-name>\n        <form-login-config>\n          <form-login-page>/crud-appserver/login/login.html<\/form-login-page>\n          <form-error-page>/crud-appserver/login/login-error.html<\/form-error-page>\n        <\/form-login-config>\n    <\/login-config>    \n    <!--END SECURITY SECTION-->\n    \n    <resource-ref>\n        <description>#crudzilla-app-name DB Connection<\/description>\n        <res-ref-name>jdbc/#crudzilla-app-nameDB<\/res-ref-name>\n        <res-type>javax.sql.DataSource<\/res-type>\n        <res-auth>Container<\/res-auth>\n    <\/resource-ref>\n<\/web-app>\n","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"8f5a617f-530a-4742-9a1f-8a61039e7107","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"jettyWebXml","type":"xml","validationRegEx":"","defaultValue":"<?xml version=\"1.0\"?>\n<!DOCTYPE Configure PUBLIC \"-//Jetty//Configure//EN\" \"http://www.eclipse.org/jetty/configure.dtd\">\n<Configure id=\"#crudzilla-app-nameApp\" class=\"org.eclipse.jetty.webapp.WebAppContext\">  \n  \n  <Set name=\"war\"><SystemProperty name=\"jetty.home\" default=\".\"/>/webapps/#crudzilla-app-name.war<\/Set>\n  <Set name=\"contextPath\">/#crudzilla-app-name<\/Set>\n  \n  <!--BEGIN SECURITY HANDLER-->\n  <Get name=\"securityHandler\">\n    <Set name=\"loginService\">\n     <New class=\"org.eclipse.jetty.security.JDBCLoginService\">\n\t    <Set name=\"name\">#crudzilla-app-name<\/Set>\n\t    <Set name=\"config\"><SystemProperty name=\"jetty.home\" default=\".\"/>/etc/#crudzilla-app-name.jdbc.realm.properties<\/Set>\n            <!-- To enable reload of realm when properties change, uncomment the following lines -->\n            <!-- changing refreshInterval (in seconds) as desired                                -->\n            <!-- <Set name=\"refreshInterval\">5<\/Set><Call name=\"start\"><\/Call> -->\n      <\/New>\n    <\/Set>\n    <Set name=\"checkWelcomeFiles\">true<\/Set>\n  <\/Get>\n  <!--END SECURITY HANDLER-->\n  \n<\/Configure>","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"5ccef9e1-9d38-4d29-8dca-f0c829c2a75b","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"getAppTaxonomies","type":"crud","validationRegEx":"","defaultValue":"../api/app-taxonomy/get-apptaxonomys.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"5cc45cd9-dd4b-4678-970f-44095e1cce9d","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"jettyEnvXml","type":"xml","validationRegEx":"","defaultValue":"<?xml version=\"1.0\"?>\n<!DOCTYPE Configure PUBLIC \"-//Jetty//Configure//EN\" \"http://www.eclipse.org/jetty/configure.dtd\">\n\n<Configure  class=\"org.eclipse.jetty.webapp.WebAppContext\">\n\n  <New id=\"#crudzilla-app-nameDB\" class=\"org.eclipse.jetty.plus.jndi.Resource\">\n    <Arg>jdbc/#crudzilla-app-nameDB<\/Arg>\n    <Arg>\n     <New class=\"org.apache.commons.dbcp.BasicDataSource\">\n          <Set name=\"driverClassName\">#crudzilla-database-driver<\/Set>\n          <Set name=\"url\">#crudzilla-database-url<\/Set>\n          <Set name=\"username\">#crudzilla-database-username<\/Set>\n          <Set name=\"password\">#crudzilla-database-password<\/Set>\n     <\/New>\n    <\/Arg>\n  <\/New>\n\n<\/Configure>","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"39ca7856-3867-49a7-b085-ee222cc49bde","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"realmProperties","type":"properties-file","validationRegEx":"","defaultValue":"jdbcdriver=#crudzilla-database-driver\nurl=#crudzilla-database-url\nusername=#crudzilla-database-username\npassword=#crudzilla-database-password\nusertable=users\nusertablekey=id\nusertableuserfield=user_name\nusertablepasswordfield=pass_word\nroletable=roles\nroletablekey=id\nroletablerolefield=role\nuserroletable=user_roles\nuserroletableuserkey=user_id\nuserroletablerolekey=role_id\ncachetime=300\n","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"231ccee8-84c0-4718-8223-4e0b2e43c3c5","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"createRolesTable","type":"sql","validationRegEx":"","defaultValue":"create table roles\n(\n     id integer,\n     role varchar(100) not null\n)","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"0a7e1ff5-bab3-4f90-b2b3-29b102600d92","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"cwabPlatformDependencies","type":"string","validationRegEx":"","defaultValue":"/crudzilla-platform","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"0"},{"id":"02ca1fc6-8af5-4e3c-a08b-c09dc5185987","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"createUsersTable","type":"sql","validationRegEx":"","defaultValue":"create table users \n(\n     id integer,\n     user_name varchar(100) not null,\n     pass_word varchar(20) not null,\n     create_date bigint not null,\n)","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"639a1347-f7de-412f-829f-046b599f869e","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"cloneCrudDefinition","type":"string","validationRegEx":"","defaultValue":"../api/primary-execution/crud-definition/clone-crud-definition.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"15"},{"id":"022c52a5-490f-44f0-85ae-bc72977ca3a9","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"addParameter","type":"string","validationRegEx":"","defaultValue":"../api/nvp-processing/add-execution-parameter.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"16"},{"id":"d6e85c37-7356-4330-8745-0a32d343088c","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"addAppTaxonomy","type":"string","validationRegEx":"","defaultValue":"../api/app-taxonomy/add-apptaxonomy.stm","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes","position":"17"},{"id":"a515f05d-7989-4970-851e-e2666cbafe9f","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"createUserProfileTable","type":"sql","validationRegEx":"","defaultValue":"create table user_profile (\n  user_id integer NOT NULL,\n  first_name varchar(256),\n  last_name varchar(256),\n  contact_email_address varchar(256),\n  area_code char(3),\n  exchange_number char(3),\n  number char(4),\n  extension char(8)\n)","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"18"}],"reference_id":"e69bd495-9922-4e96-86e2-5fe1fde69f29","accesscontrols":[]}