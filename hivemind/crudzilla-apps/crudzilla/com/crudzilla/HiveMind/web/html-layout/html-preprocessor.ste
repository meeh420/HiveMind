{"definition_id":"05547689-e90f-4005-bf2a-f2fba78f4611","last_refresh_timestamp":1394567967818,"postexecution_handlers":[],"definition":{"id":"05547689-e90f-4005-bf2a-f2fba78f4611","code":"import org.jsoup.Jsoup;\nimport org.jsoup.nodes.Element;\nimport org.jsoup.nodes.Document;\nimport org.apache.commons.io.FileUtils;\nimport com.crudzilla.platform.util.CrudzillaUtil;\n\n//extract template code to preserve\n\n//annotate templated portion of document\n\n//execute template\n\n//when it is time to save the document, replace annotated portion with original template\n\nString appModule = appBaseDir.substring(0,appBaseDir.lastIndexOf(\"/web\"));\n\nStringBuilder template = new StringBuilder(httpRequest.getSession().getAttribute(\"cachedHtml\"));\nhttpRequest.getSession().removeAttribute(\"cachedHtml\");\n\n/**\nFile f = new File(appBaseDir+\"/\"+resPath);\n\nif(f.isFile())\n\ttemplate.append(FileUtils.readFileToString(f,\"utf-8\"));\nelse\n    template.append(FileUtils.readFileToString(new File(appBaseDir+\"/\"+resPath+\"/index.html\"),\"utf-8\"));\n**/\n\n\nif(/*resPath.startsWith(\"/index.html\")*/true){\n  //generate a temp file name\n  tempFileName = tempFileName+\".vm\";\n  \n  //write this file to temp directory of the application\n  FileUtils.writeStringToFile(\n    new File(appBaseDir+\"/crudzilla-temp/\"+tempFileName),\n    template.toString(),\n    //crud.add(\"template\",template.toString()).call(\"html-template-preprocessor.ste\"),\n    \"utf-8\");\n  \n  template = new StringBuilder();\n  \n  \n  //invoke the design time template processor\n  template.append(crud.using(appModule)\n    .add(\"template\",\"/crudzilla-temp/\"+tempFileName)\n    .call(\"/crudzilla-platform/html-template-preprocessor.ste\"));\n  \n  \n  new File(appBaseDir+\"/crudzilla-temp/\"+tempFileName).delete();\n}\n//crud.logger().info(template.toString());\n\nDocument doc = Jsoup.parse(\n  template.toString()\n  //crud.add(\"template\",template.toString()).call(\"html-template-preprocessor.ste\")\n  /*new File(appBaseDir+\"/\"+resPath), \"UTF-8\", \"\"*/\n\n);\n\nidCounter = Long.valueOf(baseId);\n\ndef traverse(Element inElement/*,long idCounter*/){\n  \n  List elementList = inElement.children();\n  \n  for(Element element : elementList){\n    //if(element.children().size()>0)\n    \ttraverse(element/*,idCounter*/);\n    //else\n    //element.attr(\"data-crudzilla-element\",\"\"+(idCounter++));    \n  }  \n  //crud.logger().info(\"counter \"+idCounter);\n  inElement.attr(\"data-crudzilla-element\",\"\"+(idCounter++));\n  /*\n  if(\n     !inElement.hasAttr(\"data-crudzilla-element\") ||\n     inElement.attr(\"data-crudzilla-element\") == null || \n     inElement.attr(\"data-crudzilla-element\").isEmpty()){//don't override persistent ids\n       inElement.attr(\"data-crudzilla-element\",\"\"+(idCounter++));\n  }*/\n}\n\n\n\n//**traverse(doc);\n\nStringBuilder buf = new StringBuilder();\nbuf.append(doc.outerHtml());\n\nhttpResponse.setContentType(\"text/html;charset=UTF-8\");\nhttpResponse.setHeader(\"Content-Length\", String.valueOf(buf.length()));\nhttpResponse.getWriter().println(buf.toString());\n//crud.logger().info(buf.toString());","name":"html-preprocessor","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"yes","requireAllIdentities":"no","lastModifiedTimeStamp":"1394567963063"},"preexecution_handlers":[],"execution_parameters":[{"id":"9a3f9fe3-9f7e-46f7-8c2d-c98727cafa60","definitionId":"05547689-e90f-4005-bf2a-f2fba78f4611","required":"no","name":"idCounter","type":"long","validationRegEx":"","defaultValue":"0","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"ebebba2b-c891-485f-b306-c1d4cd3bb786","definitionId":"05547689-e90f-4005-bf2a-f2fba78f4611","required":"no","name":"tempFileName","type":"string","validationRegEx":"","defaultValue":"crudzilla_generate_uuid","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"yes","keepAliveCount":null,"isFinal":"yes","position":"1"}],"reference_id":"0a5984c8-ae7d-4144-98fd-c034ead5ab73","accesscontrols":[]}