{"definition_id":"b3e9af84-272b-4e03-83e3-d0b20bcbcda8","preexecution_handlers":[],"reference_id":"86b25e08-8087-49ed-bb56-3bccdc161d93","last_refresh_timestamp":1396553489850,"postexecution_handlers":[],"accesscontrols":[],"definition":{"id":"b3e9af84-272b-4e03-83e3-d0b20bcbcda8","code":"import net.sf.json.JSONObject;\nimport org.apache.commons.io.FileUtils;\nimport net.sf.json.JSONArray;\nimport net.sf.json.JSONNull;\nimport net.sf.json.JSONObject;\nimport java.io.*;\n\nObject product = crud.call(\"product.ins\");\n\nObject response = crud.add(\"url\",product.releaseInfoUrl)\n  .call(\"get-release-info.svc\");\n\ncrud.logger().info(\"json:\"+response.get(\"response\"));\n\nString jsonString = response.get(\"response\");\n\nObject json = JSONObject.fromObject(jsonString);\n\ncrud.logger().info(\"currentVersion:\"+json.get(\"currentVersion\"));\n\n//get release information\nObject releaseInfo = JSONObject.toBean(json);\n\n//collect all updates that need to be applied\nArrayList updates = new ArrayList();\nfor(Object release : releaseInfo.releases){\n  if(release.buildNumber.compareTo(\"\"+product.buildNumber) == 0) break;\n  updates.add(release);\n}\n\n\nfor(Object version : updates){\n  //get version selected to update to\n  //Object updateToVersion = releaseInfo.currentVersion;//releaseInfo.versions.get(selectedVersion);\n  \n  \n  String packageName = version.packageUrl.substring(version.packageUrl.lastIndexOf(\"/\")+1);\n  packageName = packageName.substring(0,packageName.lastIndexOf(\".zip\"));\n  \n  \n  \n  //download package cwab-latest\n  crud.add(\"download\",\"true\")\n      .add(\"url\",version.packageUrl)    \n      .add(\"enableUnpack\",\"true\")\n      .call(\"/file-system/download-file.svc\");\n  \n  \n  //download crudzilla-hivemind-update.xml ant script\n  ///crud.add(\"download\",\"true\")\n  //    .add(\"url\",updateToVersion.updateAntScriptUrl)\n  //    .call(\"/file-system/download-file.svc\");\n  \n  //run ant script\n  crud.add(\"scriptPath\",crud.appBaseDir()+\"/crudzilla-temp/\"+packageName+\"/hivemind-install-update.xml\")\n  .call(\"/new-web-app/ant.ste\");\n  \n  //run any db scripts\n  File dbScript = new File(crud.appBaseDir()+\"/crudzilla-temp/\"+packageName+\"/hivemind-db-update.sql\");\n  if(dbScript.exists()){//**could be done in ant script maybe?\n    \n    //get derby connection\n    arguments.put(\"dataSourceConfig\",crud.call(derbyConnection));\n    Object conn = crud.resolvePathToCaller(crudzilla.sysSettings().get(\"crudzilla_datasource_connection_creator\").toString()).call(crudzilla.sysSettings().get(\"crudzilla_datasource_connection_creator\"), arguments);\n    \n    ByteArrayOutputStream os = new ByteArrayOutputStream();\n    org.apache.derby.tools.ij.runScript(conn,\n                                        FileInputStream(dbScript),\n                                        \"utf-8\",\n                                        os,\n                                        \"utf-8\");\n    crud.logger().info(os.toString());\n  }\n}","name":"update","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"no","requireAllIdentities":"no","lastModifiedTimeStamp":"1396553488269"},"execution_parameters":[{"id":"60442821-f2f5-48c1-bd3b-6d0aa0523b21","definitionId":"b3e9af84-272b-4e03-83e3-d0b20bcbcda8","required":"no","name":"derbyConnection","type":"string","validationRegEx":"","defaultValue":"/start-up/derby.ins","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"}]}