{"definition_id":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","last_refresh_timestamp":1400891661850,"postexecution_handlers":[],"definition":{"id":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","code":"import java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport java.io.File;\nimport org.apache.commons.io.FileUtils;\nimport org.apache.commons.io.filefilter.FileFilterUtils;\nimport org.apache.commons.io.filefilter.HiddenFileFilter;\nimport org.apache.commons.io.filefilter.IOFileFilter;\nimport org.apache.commons.io.filefilter.WildcardFileFilter;\nimport org.apache.commons.io.filefilter.RegexFileFilter;\n\ndef deWindowize(String path){\n   String normalizePath = path.replace(\"\\\\\",\"/\");   \n  \n   //remove windows drive letter part of the path\n   if(normalizePath.indexOf(':') != -1)\n      normalizePath = normalizePath.substring(normalizePath.indexOf(':')+1);  \n  \n   return normalizePath;\n}\n\ndef listDir(dir,filter,updateListBuffer,pckgDir){\n\n    File[] files = FileFilterUtils.filter(filter,dir.listFiles());\n      \n    crud.logger().info(dir.getAbsolutePath()+\":\"+files.length+\"-\"+dir.listFiles().length);\n    for(File file:files){\n      if(file.isFile()){\n        \n         \n         String relPath = file.getAbsolutePath().substring(assetBasePathLength).replace('\\\\','/');          \n         updateListBuffer.append(\"<copy file=\\\"\"+relPath+\"\\\" todir=\\\"\\${jetty.home}/crudzilla-apps\"+relPath+\"\\\"/>\\n\");\n         \n         File fileLocation = new File(pckgDir.getAbsolutePath()+relPath.substring(0,relPath.lastIndexOf(\"/\")));\n         if(!fileLocation.exists())\n        \tfileLocation.mkdirs();\n        \n         FileUtils.copyFileToDirectory(file,fileLocation);\n      }\n      else\n      {\n         listDir(file,filter,updateListBuffer,pckgDir);\n      }\n    }\n}\n\ndef runUpdate(){\n  \n    IOFileFilter inclusionFilter = FileFilterUtils.or(FileFilterUtils.and(FileFilterUtils.directoryFileFilter(),HiddenFileFilter.VISIBLE),FileFilterUtils.fileFileFilter());\n    \n    if(dateRangeStartFilter != null && !dateRangeStartFilter.isEmpty()){\n      long ts = new java.text.SimpleDateFormat(\"MM/dd/yyyy hh:mm a\").parse(dateRangeStartFilter).getTime();\n      inclusionFilter = FileFilterUtils.and(FileFilterUtils.ageFileFilter(ts),inclusionFilter);\n    }\n    \n    if(dateRangeEndFilter != null && !dateRangeEndFilter.isEmpty()){\n      long ts = new java.text.SimpleDateFormat(\"MM/dd/yyyy hh:mm a\").parse(dateRangeEndFilter).getTime();\n      inclusionFilter = FileFilterUtils.and(FileFilterUtils.ageFileFilter(ts,true),inclusionFilter);      \n    }\n  \n    if(sizeRangeStartFilter != null && sizeRangeEndFilter != null && !sizeRangeStartFilter.isEmpty() && !sizeRangeEndFilter.isEmpty()){\n      inclusionFilter = FileFilterUtils.and(FileFilterUtils.sizeFileFilter(Long.valueOf(sizeRangeStartFilter)),inclusionFilter);      \n    }\n    else\n    if(sizeRangeEndFilter != null && sizeRangeStartFilter == null && !sizeRangeEndFilter.isEmpty() && !sizeRangeStartFilter.isEmpty()){\n      inclusionFilter = FileFilterUtils.and(FileFilterUtils.ageFileFilter(Long.valueOf(sizeRangeEndFilter),false),inclusionFilter);      \n    }\n    else\n    if(sizeRangeStartFilter != null && sizeRangeEndFilter != null && !sizeRangeStartFilter.isEmpty() && !sizeRangeEndFilter.isEmpty()){\n      inclusionFilter = FileFilterUtils.and(FileFilterUtils.sizeRangeFileFilter(Long.valueOf(sizeRangeStartFilter),Long.valueOf(sizeRangeEndFilter)),inclusionFilter);          \n    }\n  \n  \n    if(wildCardFilter != null && !wildCardFilter.isEmpty()){\n      String[] wcf = wildCardFilter.split(\",\");\n      inclusionFilter = FileFilterUtils.and(FileFilterUtils.notFileFilter(new WildcardFileFilter(wcf)),inclusionFilter);\n    }\n  \n    if(regExFilter != null && !regExFilter.isEmpty()){\n      inclusionFilter = FileFilterUtils.and(FileFilterUtils.notFileFilter(new RegexFileFilter(regExFilter)),inclusionFilter);\n    }      \n  \n    File pckgDir = new File(crud.appBaseDir()+\"/crudzilla-temp/\"+packageName);\n    if(!pckgDir.exists())\n     pckgDir.mkdirs();\n  \n    String assetBaseDir = new File(crud.appBaseDir()+\"/\"+crudzilla.sysSettings().get(\"crudzilla_asset_base\")).getAbsolutePath();\n    assetBasePathLength = assetBaseDir.length();\n  \n    StringBuilder updateListBuffer = new StringBuilder();\n    listDir(new File(assetBaseDir+\"/\"+relPath),inclusionFilter,updateListBuffer,pckgDir);\n  \n    File installScript = new File(crud.appBaseDir()+\"/crudzilla-temp/\"+packageName+\"/hivemind-install-update.xml\");\n  \n    //write update ant install script\n    FileUtils.writeStringToFile(installScript,updateAntScriptXML.replace(\"<COPY/>\",updateListBuffer.toString()),\"utf-8\");\n}\n\nrunUpdate();","name":"generate-update-pack","description":"","crudType":"scriptexecutor","type":"groovy","serverSideOnly":"no","requireAllIdentities":"no","lastModifiedTimeStamp":"1400891661356"},"preexecution_handlers":[],"execution_parameters":[{"id":"3d9dec01-f7f8-44e6-8cf3-fb5db330e6aa","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"updateAntScriptXML","type":"xml","validationRegEx":"","defaultValue":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!-- You may freely edit this file. -->\n<project name=\"hivemind\" default=\"install\" basedir=\".\">\n  <description>Updates Crudzilla Web Application Builder (HiveMind)<\/description>    \n  \n  <target name=\"install\">\n    \n    <copy file=\"web/test-update.html\" todir=\"${jetty.home}/crudzilla-apps/crudzilla/com/crudzilla/HiveMind/web\"/>\n    <COPY/>\n    <!--<copy file=\"hivemind.war\" todir=\"${jetty.home}/webapps\"/>-->\n  <\/target>\n<\/project>\n","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"0"},{"id":"cebf2418-4e16-4e16-9cc1-423929125f8e","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"updatesSince","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"1"},{"id":"b66585ad-d115-48bf-8528-42f10aaffabb","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"assetBasePathLength","type":"integer","validationRegEx":"","defaultValue":"0","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"10"},{"id":"e3d06c34-d9e8-430e-be48-d1a5b975a08a","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"lastUpdated","type":"long","validationRegEx":"","defaultValue":"-1","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"yes","position":"2"},{"id":"a7cc0c85-b77d-4d60-8bbc-7e94b11c994b","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"excludeFiles","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"3"},{"id":"4adb6d8c-0bba-4596-95b5-7750ded4fb14","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"dateRangeStartFilter","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"4"},{"id":"f3856e55-1476-4176-8fd8-2bce97de77c2","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"dateRangeEndFilter","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"5"},{"id":"e13e1e9c-7c9c-4cf0-bef6-7b8e956ff713","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"regExFilter","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"6"},{"id":"4ccabc8a-c118-452c-8eb0-f3428ef8d845","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"sizeRangeStartFilter","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"6"},{"id":"e635a547-6a47-4102-8ae5-6b6464c89a7a","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"sizeRangeEndFilter","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"7"},{"id":"720d6e3c-e112-49cd-8fc5-044ace659b3f","definitionId":"d0aac36d-1441-4bc2-84d7-a2d48a15fbca","required":"no","name":"wildCardFilter","type":"string","validationRegEx":"","defaultValue":"","maxLength":"","minLength":"","lineEndLength":"","maxRange":"","minRange":"","dateFormat":"","dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":"","evalLeft":"no","evalRight":"no","keepAliveCount":null,"isFinal":"no","position":"8"}],"reference_id":"3bbb6e05-fb85-4694-94de-05ee80e3710c","accesscontrols":[]}