{"definition_id":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","last_refresh_timestamp":1372790297949,"postexecution_handlers":[],"definition":{"id":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","code":"import org.apache.commons.io.FileUtils;\nimport java.io.File;\n\nimport java.sql.ResultSet;\nimport java.sql.ResultSetMetaData;\nimport java.sql.SQLException;\nimport java.util.ArrayList;\nimport java.util.HashMap;\nimport java.util.List;\nimport java.util.Map;\nimport org.apache.commons.dbutils.QueryRunner;\nimport org.apache.commons.dbutils.ResultSetHandler;\nimport com.crudzilla.platform.Crudzilla;\n\nString appName = relPath.split('/')[relPath.split('/').length-1];\n\nnew File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/classes\").mkdirs();\nFile libDir = new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/lib\");\nlibDir.mkdirs();\n\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/web.xml\"), webXml);\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/jetty-web.xml\"), jettyWebXml.replace(\"#crudzilla-app-name\",appName));\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/jetty-env.xml\"), jettyEnvXml.replace(\"#crudzilla-app-name\",appName));\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/\"+appName+\".jdbc.realm.properties\"), realmProperties.replace(\"#crudzilla-app-name\",appName).replace(\"#crudzilla-database-driver\",appName));\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/build.xml\"), buildXml.replace(\"#crudzilla-app-name\",appName));\n\n\n\nif(dataSource != null && !dataSource.isEmpty()){\n  Object dataSourceConfig = crud.call(dataSource,arguments);\n  \n  if(createAuthTables.compareTo(\"yes\") == 0){\n      arguments.put(\"dataSourceConfig\",dataSourceConfig);  \n      java.sql.Connection conn = (java.sql.Connection)crud.call(\"\"+Crudzilla.crudzilla().sysSettings().get(\"crudzilla_datasource_connection_creator\"), arguments);\n      \n    \n      String dataBaseUrl\t  = \"\";\n      String dataBaseUserName = \"\";\n      String dataBasePassWord = \"\";  \n      \n      /*if(createDatabase.compareToIgnoreCase(\"yes\") == 0){\n        new QueryRunner().update(conn,\"create database \"+dataBaseName+\";\");\n        new QueryRunner().update(conn,\"use database \"+dataBaseName+\";\");\n      }*/\n      //create users table\n      new QueryRunner().update(conn,createUsersTable);\n      \n      //create roles table\n      new QueryRunner().update(conn,createRolesTable);\n      \n      //create user_roles table\n      new QueryRunner().update(conn,createUserRolesTable);\n      \n    \n      /*\n      if(dataSourceConfig.get(\"appDatabaseUrl\") != null){\n        dataBaseUrl = dataSourceConfig.get(\"appDatabaseUrl\");\n      }\n      else{\n        dataBaseUrl = dataSourceConfig.get(\"appDatabaseUrl\");\n      }\n      */\n  }\n  \n  //create app xml configs using datasource\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/web.xml\"), webXml);\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/jetty-web.xml\"), jettyWebXml.replace(\"#crudzilla-app-name\",appName));\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/jetty-env.xml\"), jettyEnvXml.replace(\"#crudzilla-app-name\",appName));\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/\"+appName+\".jdbc.realm.properties\"), realmProperties.replace(\"#crudzilla-app-name\",appName).replace(\"#crudzilla-database-driver\",appName));\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/build.xml\"), buildXml.replace(\"#crudzilla-app-name\",appName));\n  \n  \n  //write realm information\n  FileUtils.writeStringToFile(new File(Crudzilla.crudzilla().sysSettings().get(\"crudzilla_jetty_home\")+\"/etc/\"+appName+\".jdbc.realm.properties\"),realmProperties.replace(\"#crudzilla-database-url\",dataSourceConfig.url).replace(\"#crudzilla-username\",dataSourceConfig.userName).replace(\"#crudzilla-password\",dataSourceConfig.passWord,\"utf-8\"));\n}\nelse{\n  //create app xml without datasource\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/web.xml\"), webXml);\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/jetty-web.xml\"), jettyWebXml.replace(\"#crudzilla-app-name\",appName));\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/jetty-env.xml\"), jettyEnvXml.replace(\"#crudzilla-app-name\",appName)/*.replace(\"#crudzilla-database-driver\",dataSourceConfig.driverClassName).replace(\"#crudzilla-database-username\",dataSourceConfig.userName).replace(\"#crudzilla-database-password\",dataSourceConfig.passWord).replace(\"#crudzilla-database-url\",dataSourceConfig.url)*/);\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/WEB-INF/\"+appName+\".jdbc.realm.properties\"), realmProperties.replace(\"#crudzilla-app-name\",appName)/*.replace(\"#crudzilla-database-driver\",dataSourceConfig.driverClassName).replace(\"#crudzilla-database-username\",dataSourceConfig.userName).replace(\"#crudzilla-database-password\",dataSourceConfig.passWord).replace(\"#crudzilla-database-url\",dataSourceConfig.url)*/);\n  FileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/build.xml\"), buildXml.replace(\"#crudzilla-app-name\",appName));\n}\n\n\n//copy over jar dependencies\nString[] exts = new String[1];\nexts[0] = new String(\"jar\");\n\nfor (File file : FileUtils.listFiles(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/core\"),exts,false)){\n  FileUtils.copyFileToDirectory(file,libDir);\n}\n\nfor (File file : FileUtils.listFiles(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/jvm-language-support\"),exts,false)){\n  FileUtils.copyFileToDirectory(file,libDir);\n}\n\n\n//create index page\nString html = FileUtils.readFileToString(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/web-app-template/index.html\"));\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/index.html\"),html);\n\n//create login pages\nhtml = FileUtils.readFileToString(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/web-app-template/login/login.html\"));\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/login/login.html\"),html);\n\nhtml = FileUtils.readFileToString(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/web-app-template/login/login-error.html\"));\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/login/login-error.html\"),html);\n\n//create secured index page\nhtml = FileUtils.readFileToString(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/web-app-template/secure/index.html\"));\nFileUtils.writeStringToFile(new File(crud.appBaseDir()+\"/\"+relPath+\"/secure/index.html\"),html);\n\n//copy static assets\nFileUtils.copyDirectoryToDirectory(new File(crud.appBaseDir()+\"/crud-web-app-dependencies/web-app-template/static-assets\"),new File(crud.appBaseDir()+\"/\"+relPath));\n\n//copy default system setting cruds\narguments.put(\"fromCategory\",\"com/crudzilla/CAB/system\");\narguments.put(\"toCategory\",relPath+\"/\"+appName+\".settings\");\ncrud.call(copyAppTaxonomy,arguments);\n\n\n","name":"create-web-app","description":"","crudType":"scriptexecutor","type":"groovy-file","serverSideOnly":"no","lastModifiedTimeStamp":"1370388623074"},"preexecution_handlers":[],"execution_parameters":[{"id":"02ca1fc6-8af5-4e3c-a08b-c09dc5185987","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"createUsersTable","type":"sql","validationRegEx":null,"defaultValue":"create table users \n(\n     id integer primary key,\n     username varchar(100) not null unique key,\n     pwd varchar(20) not null\n);","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"231ccee8-84c0-4718-8223-4e0b2e43c3c5","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"createRolesTable","type":"sql","validationRegEx":null,"defaultValue":"create table roles\n(\n     id integer primary key,\n     role varchar(100) not null unique key\n); ","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"39ca7856-3867-49a7-b085-ee222cc49bde","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"realmProperties","type":"properties-file","validationRegEx":null,"defaultValue":"jdbcdriver=#crudzilla-database-driver\nurl=#crudzilla-database-url\nusername=#crudzilla-database-username\npassword=#crudzilla-database-password\nusertable=users\nusertablekey=id\nusertableuserfield=user_name\nusertablepasswordfield=pass_word\nroletable=roles\nroletablekey=id\nroletablerolefield=role\nuserroletable=user_roles\nuserroletableuserkey=user_id\nuserroletablerolekey=role_id\ncachetime=300\n","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"5cc45cd9-dd4b-4678-970f-44095e1cce9d","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"jettyEnvXml","type":"xml","validationRegEx":null,"defaultValue":"<?xml version=\"1.0\"  encoding=\"ISO-8859-1\"?>\n<!DOCTYPE Configure PUBLIC \"-//Mort Bay Consulting//DTD Configure//EN\" \"http://jetty.mortbay.org/configure.dtd\">\n<Configure  class=\"org.mortbay.jetty.webapp.WebAppContext\">\n\n  <New id=\"#crudzilla-app-nameDB\" class=\"org.mortbay.jetty.plus.naming.Resource\">\n    <Arg><\/Arg>\n    <Arg>jdbc/#crudzilla-app-nameDB<\/Arg>\n    <Arg>\n     <New class=\"org.apache.commons.dbcp.BasicDataSource\">\n          <Set name=\"driverClassName\">#crudzilla-database-driver<\/Set>\n          <Set name=\"url\">#crudzilla-database-url<\/Set>\n          <Set name=\"username\">#crudzilla-database-username<\/Set>\n          <Set name=\"password\">#crudzilla-database-password<\/Set>\n     <\/New>\n    <\/Arg>\n   <\/New>\n\n<\/Configure>\n","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"5ccef9e1-9d38-4d29-8dca-f0c829c2a75b","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"getAppTaxonomies","type":"crud","validationRegEx":null,"defaultValue":"/api/datastatements/get-apptaxonomys.stm","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"8f5a617f-530a-4742-9a1f-8a61039e7107","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"jettyWebXml","type":"xml","validationRegEx":null,"defaultValue":"<?xml version=\"1.0\"  encoding=\"ISO-8859-1\"?>\n<!DOCTYPE Configure PUBLIC \"-//Mort Bay Consulting//DTD Configure//EN\" \"http://jetty.mortbay.org/configure.dtd\">\n<Configure id=\"#crudzilla-app-nameApp\" class=\"org.mortbay.jetty.webapp.WebAppContext\">\n   <Set name=\"maxFormContentSize\" type=\"int\">2000000<\/Set>\n   <Set name=\"contextPath\">/#crudzilla-app-name<\/Set>\n\n   <!--\n   <Set name=\"war\"><SystemProperty name=\"jetty.home\" default=\".\"/>/webapps/#crudzilla-app-name<\/Set>\n   -->\n  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->\n  <!-- Optional context configuration                                  -->\n  <!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->\n  <!--\n  <Set name=\"extractWAR\">false<\/Set>\n  <Set name=\"copyWebDir\">false<\/Set>\n  <Set name=\"defaultsDescriptor\"><SystemProperty name=\"jetty.home\" default=\".\"/>/etc/webdefault.xml<\/Set>\n  <Set name=\"overrideDescriptor\"><SystemProperty name=\"jetty.home\" default=\".\"/>/contexts/test.d/override-web.xml<\/Set>\n  -->\n\n  <Get name=\"securityHandler\">\n    <Set name=\"userRealm\">\n     <New class=\"org.mortbay.jetty.security.JDBCUserRealm\">\n\t    <Set name=\"name\">#crudzilla-app-name JDBC Realm<\/Set>\n\t    <Set name=\"config\"><SystemProperty name=\"jetty.home\" default=\".\"/>/etc/#crudzilla-app-name.jdbc.realm.properties<\/Set>\n            <!-- To enable reload of realm when properties change, uncomment the following lines -->\n            <!-- changing refreshInterval (in seconds) as desired                                -->\n            <!--\n            <Set name=\"refreshInterval\">5<\/Set>\n            <Call name=\"start\"><\/Call>\n            -->\n      <\/New>\n    <\/Set>\n    <Set name=\"checkWelcomeFiles\">true<\/Set>\n  <\/Get>\n\n<\/Configure>","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"9413efee-f664-49a4-80b5-826a83d82864","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"webXml","type":"xml","validationRegEx":null,"defaultValue":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<web-app version=\"2.5\" xmlns=\"http://java.sun.com/xml/ns/javaee\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd\">\n    <servlet>\n        <servlet-name>AppServer<\/servlet-name>\n        <servlet-class>com.crudzilla.server.AppServer<\/servlet-class>\n        <init-param>\n            <param-name>app-home<\/param-name>\n            <param-value>/home/bitlooter/crudzilla<\/param-value>\n        <\/init-param>\n        <init-param>\n            <param-name>app-settings<\/param-name>\n            <param-value>system/system-settings.ins<\/param-value>\n        <\/init-param>\n    <\/servlet>\n    <servlet-mapping>\n        <servlet-name>AppServer<\/servlet-name>\n        <url-pattern>/appserver/*<\/url-pattern>\n    <\/servlet-mapping>\n    <session-config>\n        <session-timeout>\n            120\n        <\/session-timeout>\n    <\/session-config>\n    <welcome-file-list>\n        <welcome-file>index.html<\/welcome-file>\n    <\/welcome-file-list>\n    <security-constraint>\n        <web-resource-collection>\n            <web-resource-name>CRUDzilla Security<\/web-resource-name>\n            <url-pattern>/sc/*<\/url-pattern>\n            \n            <url-pattern>/appserver/com/crudzilla/CAB/sc/*<\/url-pattern>\n            \n            <url-pattern>/importer/protected/*<\/url-pattern>\n        <\/web-resource-collection>\n        <auth-constraint>\n            <role-name>csr<\/role-name>\n            <role-name>csr2<\/role-name>\n            <role-name>supervisor<\/role-name>\n            <role-name>developer<\/role-name>\n        <\/auth-constraint>\n        <user-data-constraint>\n            <transport-guarantee>NONE<\/transport-guarantee>\n        <\/user-data-constraint>\n    <\/security-constraint>\n    <security-role>\n        <role-name>csr<\/role-name>\n    <\/security-role>\n    <security-role>\n        <role-name>csr2<\/role-name>\n    <\/security-role>\n    <security-role>\n        <role-name>supervisor<\/role-name>\n    <\/security-role>\n    <security-role>\n        <role-name>developer<\/role-name>\n    <\/security-role>\n\n    \n    \n    <login-config>\n        <auth-method>FORM<\/auth-method>\n        <realm-name>Crudzilla<\/realm-name>\n        <form-login-config>\n            <form-login-page>/appserver/com/crudzilla/CAB/authenticate/login.ste<\/form-login-page>\n            <form-error-page>/lierr/index.jsp<\/form-error-page>\n        <\/form-login-config>\n    <\/login-config>    \n    \n    \n    <resource-ref>\n        <description>CRUDzilla DB Connection<\/description>\n        <res-ref-name>jdbc/crudzillaDB<\/res-ref-name>\n        <res-type>javax.sql.DataSource<\/res-type>\n        <res-auth>Container<\/res-auth>\n    <\/resource-ref>\n<\/web-app>\n","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"a06c1d8c-3bb2-4946-acd4-05a3b152e8c9","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"copyAppTaxonomy","type":"crud","validationRegEx":null,"defaultValue":"/com/crudzilla/CAB/taxonomy/copy-taxonomy-category.ste","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"a964ad1d-0fa0-4781-a3fd-eb77ecc0fcbf","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"createUserRolesTable","type":"sql","validationRegEx":null,"defaultValue":"create table user_roles\n(\n     user_id integer not null,\n     role_id integer not null,\n     unique key (user_id, role_id),\n     index(user_id)\n);","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"cf8ec1ca-c9b9-4ca8-9ce3-5ea99d908972","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"buildXml","type":"xml","validationRegEx":null,"defaultValue":"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!-- You may freely edit this file. -->\n<project name=\"#crudzilla-app-name\" default=\"war\" basedir=\".\">\n    <description>Builds, tests, and runs the project #crudzilla-app-name.<\/description>    \n  \n    <war destfile=\"#crudzilla-app-name.war\" webxml=\"WEB-INF/web.xml\">\n      <lib dir=\"WEB-INF/lib\"/>\n      <webinf file=\"WEB-INF/jetty-web.xml\"/> \n      <webinf file=\"WEB-INF/jetty-env.xml\"/>      \n    <\/war>  \n<\/project>\n","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"},{"id":"f62a27d2-c9cc-4399-92c7-9a0266cf877c","definitionId":"0c3f9e44-c010-4b77-b98c-ffe910a10de4","required":"no","name":"findAppTaxonomy","type":"crud","validationRegEx":null,"defaultValue":"/com/crudzilla/CAB/taxonomy/find-category.ste","maxLength":null,"minLength":"","lineEndLength":null,"maxRange":null,"minRange":null,"dateFormat":null,"dateFormatStrict":"no","allowallschemesForURL":"no","allow2slashesForURL":"no","nofragmentsForURL":"no","schemesForURL":null,"evalLeft":"no","evalRight":"no","keepAliveCount":"","isFinal":"yes"}],"reference_id":"3fa3c5a1-5179-4fd7-8eb6-d2953abc5b38","accesscontrols":[]}